name: PR Automation v2

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  code-quality:
    name: Code Quality
    if: startsWith(github.head_ref, 'feat/') && github.base_ref == 'main'
    runs-on: ubuntu-latest
    outputs:
      eslint: ${{ steps.eslint-result.outputs.result }}
      prettier: ${{ steps.prettier-result.outputs.result }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve environment variables (primary with fallback)
        id: resolve-env
        shell: bash
        run: |
          RESOLVED_TOKEN="${{ env.GITHUB_TOKEN }}"
          if [ -z "$RESOLVED_TOKEN" ]; then RESOLVED_TOKEN="${{ env.MCP_GITHUB_TOKEN }}"; fi
          RESOLVED_OWNER="${{ env.GITHUB_ORG }}"
          if [ -z "$RESOLVED_OWNER" ]; then RESOLVED_OWNER="${{ env.GITHUB_EVAL_ORG }}"; fi
          RESOLVED_REPO="${{ env.GITHUB_REPO }}"
          if [ -z "$RESOLVED_REPO" ]; then RESOLVED_REPO="$(echo "${{ github.repository }}" | cut -d'/' -f2)"; fi
          BRANCH_SHA="${{ github.event.pull_request.head.sha }}"
          RAW_URL="https://raw.githubusercontent.com/${RESOLVED_OWNER}/${RESOLVED_REPO}/${{ github.event.pull_request.head.ref }}/.github/workflows/pr-automation-v2.yml"
          echo "RESOLVED_TOKEN=$RESOLVED_TOKEN" >> $GITHUB_ENV
          echo "RESOLVED_OWNER=$RESOLVED_OWNER" >> $GITHUB_ENV
          echo "RESOLVED_REPO=$RESOLVED_REPO" >> $GITHUB_ENV
          echo "TASK1_BRANCH_SHA=$BRANCH_SHA" >> $GITHUB_ENV
          echo "WORKFLOW_RAW_URL=$RAW_URL" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/hydrogen
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: Run ESLint
        id: eslint
        run: |
          set +e
          npm run lint | tee eslint.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Capture ESLint result
        id: eslint-result
        run: |
          RESULT=$(tail -n +1 eslint.log | tr '\n' ' ')
          echo "result=$RESULT" >> $GITHUB_OUTPUT

      - name: Run Prettier check
        id: prettier
        run: |
          set +e
          npx prettier --check . | tee prettier.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Capture Prettier result
        id: prettier-result
        run: |
          RESULT=$(tail -n +1 prettier.log | tr '\n' ' ')
          echo "result=$RESULT" >> $GITHUB_OUTPUT

      - name: Post PR comment (Code Quality)
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RESOLVED_TOKEN }}
          script: |
            const number = context.payload.pull_request.number;
            const eslint = `${{ steps.eslint-result.outputs.result }}`;
            const prettier = `${{ steps.prettier-result.outputs.result }}`;
            const body = [
              `代码质量报告 - 分支SHA: ${process.env.TASK1_BRANCH_SHA}`,
              `ESLint 结果: ${eslint}`,
              `Prettier 结果: ${prettier}`,
              `仓库: ${process.env.RESOLVED_OWNER}/${process.env.RESOLVED_REPO}`,
              `工作流RAW地址: ${process.env.WORKFLOW_RAW_URL}`
            ].join('\n');
            await github.rest.issues.createComment({
              owner: process.env.RESOLVED_OWNER,
              repo: process.env.RESOLVED_REPO,
              issue_number: number,
              body
            });
        continue-on-error: true

  testing-suite:
    name: Testing Suite
    if: startsWith(github.head_ref, 'feat/') && github.base_ref == 'main'
    runs-on: ubuntu-latest
    outputs:
      test: ${{ steps.test-result.outputs.result }}
      coverage_lines: ${{ steps.test-result.outputs.coverage_lines }}
      coverage_branches: ${{ steps.test-result.outputs.coverage_branches }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve environment variables (primary with fallback)
        id: resolve-env
        shell: bash
        run: |
          RESOLVED_TOKEN="${{ env.GITHUB_TOKEN }}"
          if [ -z "$RESOLVED_TOKEN" ]; then RESOLVED_TOKEN="${{ env.MCP_GITHUB_TOKEN }}"; fi
          RESOLVED_OWNER="${{ env.GITHUB_ORG }}"
          if [ -z "$RESOLVED_OWNER" ]; then RESOLVED_OWNER="${{ env.GITHUB_EVAL_ORG }}"; fi
          RESOLVED_REPO="${{ env.GITHUB_REPO }}"
          if [ -z "$RESOLVED_REPO" ]; then RESOLVED_REPO="$(echo "${{ github.repository }}" | cut -d'/' -f2)"; fi
          BRANCH_SHA="${{ github.event.pull_request.head.sha }}"
          RAW_URL="https://raw.githubusercontent.com/${RESOLVED_OWNER}/${RESOLVED_REPO}/${{ github.event.pull_request.head.ref }}/.github/workflows/pr-automation-v2.yml"
          echo "RESOLVED_TOKEN=$RESOLVED_TOKEN" >> $GITHUB_ENV
          echo "RESOLVED_OWNER=$RESOLVED_OWNER" >> $GITHUB_ENV
          echo "RESOLVED_REPO=$RESOLVED_REPO" >> $GITHUB_ENV
          echo "TASK1_BRANCH_SHA=$BRANCH_SHA" >> $GITHUB_ENV
          echo "WORKFLOW_RAW_URL=$RAW_URL" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/hydrogen
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: Run tests with coverage
        id: run-tests
        run: |
          set +e
          npm test -- --coverage | tee test.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Extract coverage core data
        id: test-result
        shell: bash
        run: |
          LINES="N/A"
          BRANCHES="N/A"
          if [ -f coverage/lcov.info ]; then
            LINES=$(grep -m1 'LH:' coverage/lcov.info | cut -d':' -f2 || echo "N/A")
            BRANCHES=$(grep -m1 'BRH:' coverage/lcov.info | cut -d':' -f2 || echo "N/A")
          fi
          TOTAL_TESTS=$(grep -Eo 'Tests?: [0-9]+' test.log | awk '{print $2}' | tail -n1)
          [ -z "$TOTAL_TESTS" ] && TOTAL_TESTS="N/A"
          echo "result=$(tail -n +1 test.log | tr '\n' ' ')" >> $GITHUB_OUTPUT
          echo "coverage_lines=$LINES" >> $GITHUB_OUTPUT
          echo "coverage_branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage-report-${{ github.event.pull_request.number }}
          path: ./coverage
          retention-days: 14
        continue-on-error: true

      - name: Post PR comment (Testing Suite)
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RESOLVED_TOKEN }}
          script: |
            const number = context.payload.pull_request.number;
            const lines = `${{ steps.test-result.outputs.coverage_lines }}`;
            const branches = `${{ steps.test-result.outputs.coverage_branches }}`;
            const tests = `${{ steps.test-result.outputs.total_tests }}`;
            const body = [
              `测试覆盖率报告 - 分支SHA: ${process.env.TASK1_BRANCH_SHA}`,
              `行覆盖率: ${lines}`,
              `分支覆盖率: ${branches}`,
              `执行用例数: ${tests}`,
              `仓库: ${process.env.RESOLVED_OWNER}/${process.env.RESOLVED_REPO}`,
              `工作流RAW地址: ${process.env.WORKFLOW_RAW_URL}`
            ].join('\n');
            await github.rest.issues.createComment({
              owner: process.env.RESOLVED_OWNER,
              repo: process.env.RESOLVED_REPO,
              issue_number: number,
              body
            });
        continue-on-error: true

  security-scan:
    name: Security Scan
    if: startsWith(github.head_ref, 'feat/') && github.base_ref == 'main'
    runs-on: ubuntu-latest
    outputs:
      vulnerabilities: ${{ steps.security-result.outputs.vulnerabilities }}
      gitleaks_status: ${{ steps.security-result.outputs.gitleaks_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve environment variables (primary with fallback)
        id: resolve-env
        shell: bash
        run: |
          RESOLVED_TOKEN="${{ env.GITHUB_TOKEN }}"
          if [ -z "$RESOLVED_TOKEN" ]; then RESOLVED_TOKEN="${{ env.MCP_GITHUB_TOKEN }}"; fi
          RESOLVED_OWNER="${{ env.GITHUB_ORG }}"
          if [ -z "$RESOLVED_OWNER" ]; then RESOLVED_OWNER="${{ env.GITHUB_EVAL_ORG }}"; fi
          RESOLVED_REPO="${{ env.GITHUB_REPO }}"
          if [ -z "$RESOLVED_REPO" ]; then RESOLVED_REPO="$(echo "${{ github.repository }}" | cut -d'/' -f2)"; fi
          BRANCH_SHA="${{ github.event.pull_request.head.sha }}"
          RAW_URL="https://raw.githubusercontent.com/${RESOLVED_OWNER}/${RESOLVED_REPO}/${{ github.event.pull_request.head.ref }}/.github/workflows/pr-automation-v2.yml"
          echo "RESOLVED_TOKEN=$RESOLVED_TOKEN" >> $GITHUB_ENV
          echo "RESOLVED_OWNER=$RESOLVED_OWNER" >> $GITHUB_ENV
          echo "RESOLVED_REPO=$RESOLVED_REPO" >> $GITHUB_ENV
          echo "TASK1_BRANCH_SHA=$BRANCH_SHA" >> $GITHUB_ENV
          echo "WORKFLOW_RAW_URL=$RAW_URL" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/hydrogen
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: npm audit for dependencies
        id: npm-audit
        run: |
          set +e
          npm audit --json > audit.json || true
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit.json 2>/dev/null || echo 0)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit.json 2>/dev/null || echo 0)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit.json 2>/dev/null || echo 0)
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Gitleaks scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --no-git -v
        continue-on-error: true

      - name: Determine gitleaks status
        id: gitleaks-status
        run: |
          if [ -f gitleaks-report.json ]; then
            echo "status=found" >> $GITHUB_OUTPUT
          else
            echo "status=none" >> $GITHUB_OUTPUT
          fi

      - name: Capture security results
        id: security-result
        run: |
          echo "vulnerabilities=高危:${{ steps.npm-audit.outputs.high }} 中危:${{ steps.npm-audit.outputs.moderate }} 低危:${{ steps.npm-audit.outputs.low }}" >> $GITHUB_OUTPUT
          STATUS="${{ steps.gitleaks-status.outputs.status }}"
          echo "gitleaks_status=$STATUS" >> $GITHUB_OUTPUT

      - name: Post PR comment (Security Scan)
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RESOLVED_TOKEN }}
          script: |
            const number = context.payload.pull_request.number;
            const vul = `${{ steps.security-result.outputs.vulnerabilities }}`;
            const status = `${{ steps.security-result.outputs.gitleaks_status }}`;
            const body = [
              `安全扫描报告 - 分支SHA: ${process.env.TASK1_BRANCH_SHA}`,
              `依赖项 漏洞 统计: ${vul}`,
              `机密信息 扫描状态: ${status}`,
              `仓库: ${process.env.RESOLVED_OWNER}/${process.env.RESOLVED_REPO}`,
              `工作流RAW地址: ${process.env.WORKFLOW_RAW_URL}`
            ].join('\n');
            await github.rest.issues.createComment({
              owner: process.env.RESOLVED_OWNER,
              repo: process.env.RESOLVED_REPO,
              issue_number: number,
              body
            });
        continue-on-error: true

  build-validation:
    name: Build Validation
    if: startsWith(github.head_ref, 'feat/') && github.base_ref == 'main'
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build-result.outputs.build_status }}
      endpoint_status: ${{ steps.build-result.outputs.endpoint_status }}
      artifact_size: ${{ steps.dist-info.outputs.artifact_size }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve environment variables (primary with fallback)
        id: resolve-env
        shell: bash
        run: |
          RESOLVED_TOKEN="${{ env.GITHUB_TOKEN }}"
          if [ -z "$RESOLVED_TOKEN" ]; then RESOLVED_TOKEN="${{ env.MCP_GITHUB_TOKEN }}"; fi
          RESOLVED_OWNER="${{ env.GITHUB_ORG }}"
          if [ -z "$RESOLVED_OWNER" ]; then RESOLVED_OWNER="${{ env.GITHUB_EVAL_ORG }}"; fi
          RESOLVED_REPO="${{ env.GITHUB_REPO }}"
          if [ -z "$RESOLVED_REPO" ]; then RESOLVED_REPO="$(echo "${{ github.repository }}" | cut -d'/' -f2)"; fi
          BRANCH_SHA="${{ github.event.pull_request.head.sha }}"
          RAW_URL="https://raw.githubusercontent.com/${RESOLVED_OWNER}/${RESOLVED_REPO}/${{ github.event.pull_request.head.ref }}/.github/workflows/pr-automation-v2.yml"
          echo "RESOLVED_TOKEN=$RESOLVED_TOKEN" >> $GITHUB_ENV
          echo "RESOLVED_OWNER=$RESOLVED_OWNER" >> $GITHUB_ENV
          echo "RESOLVED_REPO=$RESOLVED_REPO" >> $GITHUB_ENV
          echo "TASK1_BRANCH_SHA=$BRANCH_SHA" >> $GITHUB_ENV
          echo "WORKFLOW_RAW_URL=$RAW_URL" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/hydrogen
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: Build application
        id: build
        run: |
          set +e
          npm run build | tee build.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Prepare dist artifact (placeholder if missing)
        id: dist-info
        run: |
          mkdir -p dist
          cp -f build.log dist/build.log || true
          echo "artifact_size=$(du -sh dist | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Start app and verify endpoint
        id: endpoint
        run: |
          set +e
          nohup node server.js >/dev/null 2>&1 &
          sleep 2
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo 000)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Capture build results
        id: build-result
        run: |
          BUILD_EXIT="${{ steps.build.outputs.exit_code }}"
          ENDPOINT_STATUS="${{ steps.endpoint.outputs.status }}"
          echo "build_status=$BUILD_EXIT" >> $GITHUB_OUTPUT
          echo "endpoint_status=$ENDPOINT_STATUS" >> $GITHUB_OUTPUT

      - name: Upload deployment preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-preview-${{ github.event.pull_request.number }}
          path: ./dist
          retention-days: 14
        continue-on-error: true

      - name: Post PR comment (Build Validation)
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RESOLVED_TOKEN }}
        
          script: |
            const number = context.payload.pull_request.number;
            const buildStatus = `${{ steps.build-result.outputs.build_status }}`;
            const endpointStatus = `${{ steps.build-result.outputs.endpoint_status }}`;
            const artifactSize = `${{ steps.dist-info.outputs.artifact_size }}`;
            const body = [
              `构建验证 - 分支SHA: ${process.env.TASK1_BRANCH_SHA}`,
              `端点可达性 状态码: ${endpointStatus}`,
              `部署预览 工件: deployment-preview-${number}`,
              `构建产物大小: ${artifactSize}`,
              `仓库: ${process.env.RESOLVED_OWNER}/${process.env.RESOLVED_REPO}`,
              `工作流RAW地址: ${process.env.WORKFLOW_RAW_URL}`
            ].join('\n');
            await github.rest.issues.createComment({
              owner: process.env.RESOLVED_OWNER,
              repo: process.env.RESOLVED_REPO,
              issue_number: number,
              body
            });
        continue-on-error: true
